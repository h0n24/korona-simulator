<!DOCTYPE html>
<head>
  <script>
    var context;
    var gctx;
    var stop = false;
    var dots = [];
    var maxX = 500;
    var maxY = 400;

    var dotcount = 500;

    var radius = 5;

    var bouncing = false;

    var bigstep = 0;
    var bigtime = 0;
    var smalltime = 0;
    var bigtimeScale = 5;
    var bigstepCount = 15;

    var quarantineUpPct = 0.1;
    var quarantineDownPct = 0.05;
    var quarantinePower = 6;

    var mortality = 0.04;
    var reinfection = 0.02;
    var transfer = 0.4;

    var mouthOut = 0.1;
    var mouthIn = 0.01;

    var moveWhenSick = false;

    var quarantineUp = quarantineUpPct * dotcount;
    var quarantineDown = quarantineDownPct * dotcount;

    var scale = function(val) {
      return (0xcc - Math.floor(val) * 17).toString(16);
    };

    var drawOne = function(context, dot) {
      var col = "#aaaaaa";
      if (dot.infected) {
        col = "#" + scale(dot.infected) + "ff" + scale(dot.infected);
      }
      if (dot.sick) {
        col = "#ff" + scale(10 - dot.sick) + scale(10 - dot.sick);
      }
      if (dot.cured) {
        col = "#8888ff";
      }
      if (dot.dead) {
        col = "#000000";
        //return;
      }
      context.beginPath();
      context.fillStyle = col;
      context.arc(dot.x, dot.y, radius, 0, Math.PI * 2, true);
      context.closePath();
      context.fill();

      //mouth
      if (dot.mouth < 1) {
        context.beginPath();
        context.strokeStyle = "#ffffff";
        context.arc(dot.x, dot.y, radius - 2, Math.PI, Math.PI * 2, true);
        context.closePath();
        context.stroke();
      }

      if (dot.quarantine) {
        context.beginPath();
        context.strokeStyle = "#ffff00";
        context.arc(dot.x, dot.y, radius + 2, 0, Math.PI * 2, true);
        context.closePath();
        context.stroke();
      }
    };

    var dist = function(x1, y1, x2, y2) {
      var a = x1 - x2;
      var b = y1 - y2;
      var dist = Math.sqrt(a * a + b * b);
      return dist < radius * 2;
    };

    var genDot = function() {
      //try to find a position
      var x, y;
      var mx = maxX - 2 * radius;
      var my = maxY - 2 * radius;
      while (true) {
        x = Math.floor(Math.random() * mx) + radius;
        y = Math.floor(Math.random() * my) + radius;
        if (dots.length === 0) break;
        var test = dots
          .map(function(q) {
            return dist(q.x, q.y, x, y);
          })
          .reduce(function(p, c) {
            return c ? true : p;
          }, false);
        if (!test) break;
      }
      return {
        x: x,
        y: y,
        sane: 1,
        infected: 0,
        sick: 0,
        cured: 0,
        dead: 0,
        mortality: mortality,
        dx: Math.random() * 4 - 2,
        dy: Math.random() * 4 - 2,
        quarantine: 0,
        mouth: 1
      };
    };

    var drawAll = function(context) {
      context.clearRect(0, 0, maxX, maxY);
      for (var i = 0; i < dots.length; i++) {
        drawOne(context, dots[i]);
      }
    };

    //------

    var quarantine = function(amo) {
      //čtvrtina se nehýbe
      for (var i = 0; i < dotcount; i++) {
        if (i % 4 > amo) {
          /*
          dots[i].dx = 0;
          dots[i].dy = 0;
          */
          dots[i].quarantine = 1;
        } else {
          dots[i].quarantine = 0;
        }
      }
    };

    var quarantine8 = function(amo) {
      //čtvrtina se nehýbe
      for (var i = 0; i < dotcount; i++) {
        if (i % 8 > amo) {
          /*
                    dots[i].dx = 0;
                    dots[i].dy = 0;
                    */
          dots[i].quarantine = 1;
        } else {
          dots[i].quarantine = 0;
        }
      }
    };

    var stats = function(bigtime, doBig) {
      var pct = dotcount / 100;
      var s = dots.reduce(
        function(p, c) {
          if (c.sane) {
            p.sane++;
          } else if (c.sick) {
            p.sick++;
          } else if (c.infected) {
            p.infected++;
          } else if (c.cured) {
            p.cured++;
          } else if (c.dead) {
            p.dead++;
          }
          return p;
        },
        { sane: 0, sick: 0, infected: 0, cured: 0, dead: 0 }
      );
      document.getElementById("sane").innerText = s.sane;
      document.getElementById("cured").innerText = s.cured;
      document.getElementById("infected").innerText = s.infected;
      document.getElementById("dead").innerText = s.dead;
      document.getElementById("sick").innerText = s.sick;

      document.getElementById("bigtime").innerText = bigtime + 1;

      if (s.sick > quarantineUp) quarantine8(7 - quarantinePower);
      if (s.sick < quarantineDown) quarantine8(7);

      //graf
      if (doBig === 0) {
        var v = 0;

        gctx.beginPath();
        gctx.moveTo(bigtime, 100 - v);
        gctx.lineTo(bigtime, 100 - v - s.infected / pct);
        gctx.strokeStyle = "#00ff00";
        gctx.stroke();
        v += s.infected / pct;

        gctx.beginPath();
        gctx.moveTo(bigtime, 100 - v);
        gctx.lineTo(bigtime, 100 - v - s.sick / pct);
        gctx.strokeStyle = "#ff0000";
        gctx.stroke();
        v += s.sick / pct;

        gctx.beginPath();
        gctx.moveTo(bigtime, 100 - v);
        gctx.lineTo(bigtime, 100 - v - s.sane / pct);
        gctx.strokeStyle = "#aaaaaa";
        gctx.stroke();
        v += s.sane / pct;

        gctx.beginPath();
        gctx.moveTo(bigtime, 100 - v);
        gctx.lineTo(bigtime, 100 - v - s.cured / pct);
        gctx.strokeStyle = "#0000ff";
        gctx.stroke();
        v += s.cured / pct;

        gctx.beginPath();
        gctx.moveTo(bigtime, 100 - v);
        gctx.lineTo(bigtime, 0);
        gctx.strokeStyle = "#000000";
        gctx.stroke();
      }

      if (s.infected + s.sick === 0) {
        stop = true;
      }
    };

    var step = function() {
      bigstep++;
      smalltime++;
      stats(Math.floor(smalltime / bigtimeScale), smalltime % bigtimeScale);

      if (bigstep > bigstepCount) {
        bigstep = 0;
        bigtime++;
      }
      for (var i = 0; i < dots.length; i++) {
        var dot = dots[i];
        //if (dot.dead) continue;
        //        if (bigstep === 0) {
        //Průběh infekce
        if (dot.sick) {
          dot.sick += 0.1;
          if (dot.sick > 10) {
            dot.sick = 0;
            //smrt!
            if (Math.random() < dot.mortality) {
              dot.dead = 1;
            } else {
              dot.cured = 1;
              //uzdravení se zase hýbou
              dot.dx = Math.random() * 2 - 1;
              dot.dy = Math.random() * 2 - 1;
            }
          }
        } else if (dot.infected) {
          dot.sane = 0;
          dot.infected += 0.1;
          if (dot.infected > 10) {
            dot.infected = 0;
            dot.sick = 1;

            //nemocní se nehýbou
            if (!moveWhenSick) {
              dot.dx = 0;
              dot.dy = 0;
            }
          }
        }
        //        }

        //move
        var newx = dot.x + dot.dx;
        var newy = dot.y + dot.dy;
        if (newx < radius) {
          dot.dx *= -1;
        }
        if (newy < radius) {
          dot.dy *= -1;
        }
        if (newx > maxX - radius) {
          dot.dx *= -1;
        }
        if (newy > maxY - radius) {
          dot.dy *= -1;
        }

        //collision detection
        var test = dots.map(function(q, idx) {
          if (idx == i) return false;
          if (q.dead) return false;
          return dist(q.x, q.y, newx, newy);
        });
        var hasCol = test.reduce(function(p, c) {
          return c ? true : p;
        }, false);
        if (hasCol && dot.dead === 0) {
          var which = test.reduce(function(p, c, idx) {
            return c ? idx : p;
          }, -1);
          //console.log(which, hasCol);
          if (which !== -1 && dots[which].dead === 0) {
            if (bouncing) {
              var ddx = dot.dx;
              var ddy = dot.dy;
              dot.dx = dots[which].dx;
              dot.dy = dots[which].dy;
              dots[which].dx = ddx;
              dots[which].dy = ddy;
            }

            //spread infection
            if (dots[which].infected || dots[which].sick) {
              if (dot.sane) {
                if (dots[which].infected) {
                  if (Math.random() < transfer * dots[which].mouth) {
                    dot.infected = 1;
                  }
                } else {
                  if (
                    Math.random() <
                    (transfer / dots[which].sick) * dots[which].mouth
                  ) {
                    dot.infected = 1;
                  }
                }
              }
              if (dot.cured) {
                //reinfection

                if (dots[which].infected) {
                  if (Math.random() < reinfection * dots[which].mouth) {
                    dot.cured = 0;
                    dot.infected = 1;
                    dot.mortality *= 5;
                  }
                } else {
                  if (
                    Math.random() <
                    (reinfection / dots[which].sick) * dots[which].mouth
                  ) {
                    dot.cured = 0;
                    dot.infected = 1;
                    dot.mortality *= 5;
                  }
                }
              }
            }
            if (dot.infected || dot.sick) {
              if (dots[which].sane) {
                if (dot.infected) {
                  if (Math.random() < transfer * dot.mouth) {
                    dots[which].infected = 1;
                  }
                } else {
                  if (Math.random() < (transfer / dot.sick) * dot.mouth) {
                    dots[which].infected = 1;
                  }
                }
              }
              if (dots[which].cured) {
                //reinfection
                if (dot.infected) {
                  if (Math.random() < reinfection * dot.mouth) {
                    dots[which].cured = 1;
                    dots[which].infected = 1;
                    dots[which].mortality *= 5;
                  }
                } else {
                  if (Math.random() < (reinfection / dot.sick) * dot.mouth) {
                    dots[which].cured = 1;
                    dots[which].infected = 1;
                    dots[which].mortality *= 5;
                  }
                }
              }
            }
          }
          //console.log("col", which);
        }

        if (dot.dead) {
          dot.dx = 0;
          dot.dy = 0;
        }
        newx = dot.x + dot.dx;
        newy = dot.y + dot.dy;
        if (!dot.quarantine) {
          dot.x = newx;
          dot.y = newy;
        }
      }
    };

    function raf() {
      drawAll(context);
      if (!stop) step();
      if (bigtime / bigtimeScale < 500) requestAnimationFrame(raf);
    }

    function init() {
      console.log("GO");
      var myCanvas = document.getElementById("myCanvas");
      context = myCanvas.getContext("2d");
      var graph = document.getElementById("graph");
      gctx = graph.getContext("2d");
      for (var i = 0; i < dotcount; i++) {
        dots.push(genDot());
      }
      dots[0].sane = 0;
      dots[0].infected = 1;

      /*
      //čtvrtina má roušky
      for (var i = 0; i < dotcount; i++) {
        if (i % 4 > 2) {
          dots[i].mouth = mouthOut;
        }
      }
      */

      raf();
    }
  </script>
</head>
<body onload="init()">
  <canvas id="graph" width="500" height="100"></canvas><br />
  <canvas id="myCanvas" width="500" height="400"></canvas>
  <p>
    Den:<span id="bigtime"></span> |Zdraví:<span id="sane"></span> |
    Nakažení:<span id="infected"></span> | Nemocní:<span id="sick"></span> |
    Vyléčení:<span id="cured"></span> | Mrtví:<span id="dead"></span>
  </p>
</body>
